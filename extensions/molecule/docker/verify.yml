---
- name: Verify
  hosts: instance
  become: true
  tasks:
    - name: "Verify docker-ce package is installed"
      ansible.builtin.package_facts:
        manager: auto

    - name: "Assert docker-ce package is installed"
      ansible.builtin.assert:
        that:
          - "'docker-ce' in ansible_facts.packages"
        fail_msg: "docker-ce package is not installed."
        success_msg: "docker-ce package is installed."

    - name: "Assert docker-ce-cli package is installed"
      ansible.builtin.assert:
        that:
          - "'docker-ce-cli' in ansible_facts.packages"
        fail_msg: "docker-ce-cli package is not installed."
        success_msg: "docker-ce-cli package is installed."

    - name: "Assert containerd.io package is installed"
      ansible.builtin.assert:
        that:
          - "'containerd.io' in ansible_facts.packages"
        fail_msg: "containerd.io package is not installed."
        success_msg: "containerd.io package is installed."

    - name: "Assert docker-compose-plugin package is installed"
      ansible.builtin.assert:
        that:
          - "'docker-compose-plugin' in ansible_facts.packages"
        fail_msg: "docker-compose-plugin package is not installed."
        success_msg: "docker-compose-plugin package is installed."

    - name: "Gather service facts"
      ansible.builtin.service_facts:

    - name: "Assert docker service is enabled and running"
      ansible.builtin.assert:
        that:
          - "'docker.service' in ansible_facts.services"
          - ansible_facts.services['docker.service'].status == 'enabled'
          - ansible_facts.services['docker.service'].state == 'running'
        fail_msg: "docker service is not enabled or running."
        success_msg: "docker service is enabled and running."

    - name: "Verify docker repository is configured"
      ansible.builtin.stat:
        path: /etc/apt/sources.list.d/docker.sources
      register: docker_repo_file

    - name: "Assert docker repository file exists"
      ansible.builtin.assert:
        that:
          - docker_repo_file.stat.exists
        fail_msg: "Docker repository is not configured."
        success_msg: "Docker repository is configured."

    - name: "Verify compose workdir exists"
      ansible.builtin.stat:
        path: "/opt/testapp"
      register: compose_workdir

    - name: "Assert compose workdir exists"
      ansible.builtin.assert:
        that:
          - compose_workdir.stat.exists
          - compose_workdir.stat.isdir
        fail_msg: "Compose workdir does not exist."
        success_msg: "Compose workdir exists."

    - name: "Verify compose file exists"
      ansible.builtin.stat:
        path: "/opt/testapp/compose.yml"
      register: compose_file

    - name: "Assert compose file exists"
      ansible.builtin.assert:
        that:
          - compose_file.stat.exists
        fail_msg: "Compose file does not exist."
        success_msg: "Compose file exists."

    - name: "Verify compose file content"
      ansible.builtin.slurp:
        src: "/opt/testapp/compose.yml"
      register: compose_content

    - name: "Assert compose file is not empty"
      ansible.builtin.assert:
        that:
          - compose_content.content | length > 0
        fail_msg: "Compose file is empty."
        success_msg: "Compose file is not empty."

    - name: "Verify docker can run containers"
      ansible.builtin.command:
        cmd: "docker ps"
      register: docker_ps
      changed_when: false

    - name: "Assert docker is functional"
      ansible.builtin.assert:
        that:
          - docker_ps.rc == 0
        fail_msg: "Docker is not functional."
        success_msg: "Docker is functional."
